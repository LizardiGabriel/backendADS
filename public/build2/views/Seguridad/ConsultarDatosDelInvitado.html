<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMeet - Datos del Invitado</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="../../css/app.css">
    <!--SiderBar-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div id="headers"></div>

    <main class="contenidoPrincipal">
        <div class="HeroInvitado">
            <h1 class="consultaForm__titulo text-center">Datos del invitado</h1>
            <div class="row">
                <div class="col-md-4">
                    <div class="HeroInvitadoImg">
                        <img src="../../img/examples/sample-dwight-k-schrute.jpg" class="img-fluid rounded-circle"
                            alt="Invitado" id="fotitoInvitado">
                    </div>
                </div>
                <div class="col-md-8">
                    <div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label HeroInvitadolabel">Invitado:</label>
                            <div class="col-sm-9">
                                <input id="nombre_invitado" class="form-control HeroInvitadoinput" type="text"
                                    value="José Manuel Perez" disabled>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label HeroInvitadolabel">Anfitrión:</label>
                            <div class="col-sm-9">
                                <input id="nombre_anfitrion" class="form-control HeroInvitadoinput" type="text"
                                    value="Nombre Anfitrión" disabled>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label HeroInvitadolabel">Empresa/Organización:</label>
                            <div class="col-sm-9">
                                <input id="empresa_invitado" class="form-control HeroInvitadoinput" type="text"
                                    value="Super Secret Intelligence" disabled>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label HeroInvitadolabel">Identificación a presentar:</label>
                            <div class="col-sm-9">
                                <input id="identificacion_invitado" class="form-control HeroInvitadoinput" type="text"
                                    value="INE" disabled>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label HeroInvitadolabel">Número de piso:</label>
                            <div class="col-sm-3">
                                <input id="piso_sala" class="form-control HeroInvitadoinput" type="number" value="21"
                                    disabled>
                            </div>
                            <label class="col-sm-3 col-form-label HeroInvitadolabel">Número de sala:</label>
                            <div class="col-sm-3">
                                <input id="numero_sala" class="form-control HeroInvitadoinput" type="number" value="6"
                                    disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="HeroEntradasSalidas">
                <h2>Control de Acceso</h2>
                <div class="__Tabla table-responsive paragraph-example">
                    <table class="tabla table table-hover table-bordered table-sm" id="TablaEntradasSalidas">
                        <thead class="tabla__cabecera">
                            <tr>
                                <th scope="col" data-sort="Dispositivos" class="cabecera">Hora de Entrada</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Hora de Salida</th>
                                <th scope="col" data-sort="Eliminar" class="cabecera">Eliminar registro</th>
                            </tr>
                        </thead>
                        <tbody class="tabla__cuerpo" id="tabla_acceso">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="BotonesEyS">
                <button id="btnEntrada" class="BotonesEyS__Entrada">Registrar Entrada</button>
                <button id="btnSalida" class="BotonesEyS__Salida">Registrar Salida</button>
            </div>
            <div class="HeroDispositivos">
                <h2>Dispositivos Electrónicos</h2>
                <div class="__Tabla table-responsive paragraph-example">
                    <table class="tabla table table-hover table-bordered table-sm" id="TablaDispositivos">
                        <thead class="tabla__cabecera">
                            <tr>
                                <th scope="col" data-sort="Dispositivos" class="cabecera">Marca</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Modelo</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Número de Serie</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Presente</th>
                            </tr>
                        </thead>
                        <tbody class="tabla__cuerpo" id="tabla_dispositivos">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="HeroDispositivos">
                <h2>Automóviles</h2>
                <div class="__Tabla table-responsive paragraph-example">
                    <table class="tabla table table-hover table-bordered table-sm" id="TablaCarros">
                        <thead class="tabla__cabecera">
                            <tr>
                                <th scope="col" data-sort="Dispositivos" class="cabecera">Marca</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Modelo</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Matrícula</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Color</th>
                                <th scope="col" data-sort="NumSerie" class="cabecera">Presente</th>
                            </tr>
                        </thead>
                        <tbody class="tabla__cuerpo" id="tabla_carros">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div>
            <button id="confirmarDispositivos">Confirmar Dispositivos</button>
            <button id="confirmarAutomoviles">Confirmar Automóviles</button>
        </div>
    </main>

    <div id="footers"></div>


<!-- Estilos para el Swal -->
<style>
  .titleSize{
    font-size: 4rem;
  }
  .contentSize{
    font-size: 2rem !important;
  }
  .buttonSize{
    font-size: 2rem !important;
  }
  .iconSize{
    font-size: 1.5rem;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
        window.onload = function () {
            let idReunion = 0;
            let idInvitado = 0;
            let idInvitacion = 0;
            let url = new URLSearchParams(location.search);

            idReunion = url.get('idReunion');
            idInvitado = url.get('idInvitado');
            idInvitacion = url.get('idInvitacion');

            const data = {
                idReunion: idReunion,
                idInvitado: idInvitado,
                idInvitacion: idInvitacion
            }

            fetch("/seguridad/reuniones/invitadoInf", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);

                    document.getElementById("fotitoInvitado").src = data.invitado.foto_invitado;
                    document.getElementById("nombre_invitado").value = `${data.invitado.nombre_invitado} ${data.invitado.apellido_paterno_invitado} ${data.invitado.apellido_materno_invitado}`;
                    document.getElementById("nombre_anfitrion").value = `${data.reunion.usuario.nombre_usuario} ${data.reunion.usuario.apellido_paterno_usuario} ${data.reunion.usuario.apellido_materno_usuario}`;
                    document.getElementById("empresa_invitado").value = data.invitado.empresa_invitado;
                    document.getElementById("identificacion_invitado").value = data.invitado.identificacion_invitado;
                    document.getElementById("piso_sala").value = data.reunion.sala.piso_sala;
                    document.getElementById("numero_sala").value = data.reunion.sala.numero_sala;

                    let tablaDispositivos = document.getElementById("tabla_dispositivos");
                    data.dispositivo_electronico.forEach(dispositivo => {
                        let fila = document.createElement("tr");
                        fila.innerHTML = `
                            <td>${dispositivo.marca_dispositivo_electronico}</td>
                            <td>${dispositivo.modelo_dispositivo_electronico}</td>
                            <td>${dispositivo.no_serie_dispositivo_electronico}</td>
                            <td><input type="checkbox" class="dispositivoPresente" value="${dispositivo.id_dispositivo_electronico}"></td>
                        `;
                        tablaDispositivos.appendChild(fila);
                    });

                    let tablaAutos = document.getElementById("tabla_carros");
                    data.Automovil.forEach(carro => {
                        let fila = document.createElement("tr");
                        fila.innerHTML = `
                        <td>${carro.marca_automovil}</td>
                        <td>${carro.modelo_automovil}</td>
                        <td>${carro.matricula_automovil}</td>
                        <td>${carro.color_automovil}</td>
                        <td><input type="checkbox" class="automovilPresente" value="${carro.id_automovil}"></td>
                    `;
                        tablaAutos.appendChild(fila);
                    });

                    let tablaAcceso = document.getElementById("tabla_acceso");
                    data.acceso.forEach(acceso => {
                        const row = tablaAcceso.insertRow();
                        row.insertCell(0).textContent = acceso.hora_entrada;
                        row.insertCell(1).textContent = acceso.hora_salida;
                        const deleteCell = row.insertCell(2);
                        const deleteButton = document.createElement("button");
                        deleteButton.textContent = "Eliminar";
                        deleteButton.onclick = function () {
                            row.remove();
                        };
                        deleteCell.appendChild(deleteButton);
                    });
                })
                .catch((error) => {
                    console.error('Error:', error);
                });

            document.getElementById("btnEntrada").onclick = function () {
                registrarHora("entrada");
            };

            document.getElementById("btnSalida").onclick = function () {
                registrarHora("salida");
            };

            function registrarHora(tipo) {
                const tablaAcceso = document.getElementById("tabla_acceso");
                const currentTime = new Date().toLocaleTimeString();

                if (tipo === "entrada") {
                    const row = tablaAcceso.insertRow();
                    row.insertCell(0).textContent = currentTime;
                    row.insertCell(1).textContent = "";

                    const deleteCell = row.insertCell(2);
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Eliminar";
                    deleteButton.onclick = function () {
                        row.remove();
                    };
                    deleteCell.appendChild(deleteButton);

                } else if (tipo === "salida") {
                    const lastRow = tablaAcceso.rows[tablaAcceso.rows.length - 1];
                    if (lastRow && lastRow.cells[1].textContent === "") {
                        lastRow.cells[1].textContent = currentTime;
                    } else {
                        const row = tablaAcceso.insertRow();
                        row.insertCell(0).textContent = "";
                        row.insertCell(1).textContent = currentTime;

                        const deleteCell = row.insertCell(2);
                        const deleteButton = document.createElement("button");
                        deleteButton.textContent = "Eliminar";
                        deleteButton.onclick = function () {
                            row.remove();
                        };
                        deleteCell.appendChild(deleteButton);
                    }
                }
            }

            document.getElementById('confirmarDispositivos').addEventListener('click', async () => {
                const dispositivos = Array.from(document.querySelectorAll('.dispositivoPresente:checked')).map(checkbox => checkbox.value);
                if (dispositivos.length === 0) {
                    // Mostrar mensaje de error porque no se seleccionó ningún dispositivo
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona al menos un dispositivo para confirmar.',
                        confirmButtonText: 'Aceptar'
                    });
                    return; // Detener la ejecución
                }
                if (dispositivos.length > 0) {
                    const response = await fetch('/seguridad/confirmarDispositivo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idInvitacion: idInvitacion, dispositivos })
                    });
                    const result = await response.json();
                    console.log(result);
                    //muestra mensaje en pantalla de "guardado exitoso" si el resultado es success
                    if (result.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Guardado exitoso',
                            showConfirmButton: true,
                            timer: 1500
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al guardar',
                            text: 'Ocurrió un error al guardar los dispositivos',
                            showConfirmButton: true,
                            timer: 1500
                        });
                    }

                }
            });

            document.getElementById('confirmarAutomoviles').addEventListener('click', async () => {
                const automoviles = Array.from(document.querySelectorAll('.automovilPresente:checked')).map(checkbox => checkbox.value);
                if (automoviles.length === 0) {
                    // Mostrar mensaje de error porque no se seleccionó ningún dispositivo
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona al menos un automovil para confirmar.',
                        confirmButtonText: 'Aceptar'
                    });
                    return; // Detener la ejecución
                }
                if (automoviles.length > 0) {
                    const response = await fetch('/seguridad/confirmarAutomovil', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idInvitacion: idInvitacion, automoviles })
                    });
                    const result = await response.json();
                    console.log(result);
                    //muestra mensaje en pantalla de "guardado exitoso" si el resultado es success
                    if (result.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Guardado exitoso',
                            showConfirmButton: true,
                            timer: 1500
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al guardar',
                            text: 'Ocurrió un error al guardar los dispositivos',
                            showConfirmButton: true,
                            timer: 1500
                        });
                    }
                }
            });
        }
    </script>
    <script src="../../js/seguridad/seguridad.js"></script>
    <script src="../../js/seguridad/headers.js"></script>
    <script src="../../js/header.js"></script>
    <script src="../../js/sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>